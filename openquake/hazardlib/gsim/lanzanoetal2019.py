# -*- coding: utf-8 -*-
# vim: tabstop=4 shiftwidth=4 softtabstop=4
#
# Copyright (C) 2014-2020 GEM Foundation
#
# OpenQuake is free software: you can redistribute it and/or modify it
# under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# OpenQuake is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with OpenQuake. If not, see <http://www.gnu.org/licenses/>.

"""
Module exports :class:`LanzanoEtAl2019Rjb`.
               :class:`LanzanoEtAl2019Rrup`,
"""
import numpy as np
from scipy.constants import g

from openquake.hazardlib.gsim.base import GMPE, CoeffsTable
from openquake.hazardlib import const
from openquake.hazardlib.imt import PGA, PGV, SA


class LanzanoEtAl2019Rjb(GMPE):
    """
    Implements GMPE developed by Lanzano, Giovanni & Luzi, Lucia & Pacor, Francesca & Felicetta, Chiara & Puglia, Rodolfo & Sgobba, Sara & D'Amico, Maria. (2019). A Revised Ground-Motion Prediction Model for Shallow Crustal Earthquakes in Italy. Bulletin of the Seismological Society of America. 109. 10.1785/0120180210. 
    """
    #: Supported tectonic region type is 'active shallow crust' because the
    #: equations have been derived from data from Italian database ITACA, as
    #: explained in the 'Introduction'.
    DEFINED_FOR_TECTONIC_REGION_TYPE = const.TRT.ACTIVE_SHALLOW_CRUST

    #: Set of :mod:`intensity measure types <openquake.hazardlib.imt>`
    #: this GSIM can calculate. A set should contain classes from module
    #: :mod:`openquake.hazardlib.imt`.
    DEFINED_FOR_INTENSITY_MEASURE_TYPES = set([
        PGA,
        PGV,
        SA
    ])

    #: Supported intensity measure component is the geometric mean of two
    #: horizontal components
    DEFINED_FOR_INTENSITY_MEASURE_COMPONENT = const.IMC.RotD50

    #: Supported standard deviation types are inter-event, intra-event
    #: and total, page 1904
    DEFINED_FOR_STANDARD_DEVIATION_TYPES = set([
        const.StdDev.TOTAL,
    ])

    #: Required site parameter is only Vs30
    REQUIRES_SITES_PARAMETERS = set(('vs30', ))

    #: Required rupture parameters are magnitude and rake (eq. 1).
    REQUIRES_RUPTURE_PARAMETERS = set(('rake', 'mag'))

    #: Required distance measure is RRup (eq. 1).
    REQUIRES_DISTANCES = set(('rjb', ))

    def get_mean_and_stddevs(self, sites, rup, dists, imt, stddev_types):
        """
        See :meth:`superclass method
        <.base.GroundShakingIntensityModel.get_mean_and_stddevs>`
        for spec of input and result values.
        """
        # extracting dictionary of coefficients specific to required
        # intensity measure type.

        C = self.COEFFS[imt]

        imean = self._get_mean(C, rup, dists, sites)
        # Convert units to g,
        # but only for PGA and SA (not PGV):
        if imt.name in "SA PGA":
            mean = np.log((10.0 ** (imean - 2.0)) / g)
        else:
            # PGV:
            mean = np.log(10.0 ** imean)

        istddevs = self._get_stddevs(C,
                                     stddev_types,
                                     num_sites=len(sites.vs30))

        # Return stddevs in terms of natural log scaling
        stddevs = np.log(10.0 ** np.array(istddevs))
        # mean_LogNaturale = np.log((10 ** mean) * 1e-2 / g)
        return mean, stddevs

    def _get_mean(self, C, rup, dists, sites):
        """
        Returns the mean ground motion
        """

        return (C['a']+self._compute_magnitude(rup.mag, C) +
            self._compute_distance(rup.mag, dists.rjb, C) +
            self._get_site_amplification_term(sites.vs30, C) +
            self._get_mechanism(rup, C))


    def _get_stddevs(self, C, stddev_types, num_sites):
        """
        Return standard deviations as defined in table 1.
        """
        stddevs = []
        for stddev_type in stddev_types:
            assert stddev_type in self.DEFINED_FOR_STANDARD_DEVIATION_TYPES
            if stddev_type == const.StdDev.TOTAL:
                sigma=np.sqrt(C['tau']**2+C['phi_S2S']**2+C['phi_0']**2)
                stddevs.append(sigma + np.zeros(num_sites))
        return stddevs

    def _compute_distance(self, mag, rval, C):
        """
        """
        rval = np.sqrt(rval ** 2 + C['h'] ** 2)
        return (C['c1']*(mag - C['Mref']) + C['c2'])*np.log10(rval) + C['c3'] * (rval)

    def _compute_magnitude(self, mag, C):
        """

        """
        if mag <= C['Mh']:
            return C['b1'] * (mag - C['Mh']) 
        else:
            return C["b2"] * (mag - C['Mh'])

    def _get_site_amplification_term(self, vs30, C):
        """
        Returns the site amplification term  (v0 in m/s)
        """
        if(vs30<=1500):
            v0=vs30
        else:
            v0=1500

        return C["k"] * np.log10(v0 / 800.)


    def _get_mechanism(self, rup, C):
        """
        Get fault type dummy variables
        """
        f3=0
        SS, TF, NF = self._get_fault_type_dummy_variables(rup)

        return C['f1'] * SS + C['f2'] * TF + f3 * NF

    def _get_fault_type_dummy_variables(self, rup):
        """
        Fault type (Strike-slip, Normal, Thrust/reverse) is
        derived from rake angle.
        Rakes angles within 30 of horizontal are strike-slip,
        angles from 30 to 150 are reverse, and angles from
        -30 to -150 are normal.
        """
        SS, TF, NF = 0, 0, 0
        if np.abs(rup.rake) <= 30.0 or (180.0 - np.abs(rup.rake)) <= 30.0:
            # strike-slip
            SS = 1
        elif rup.rake > 30.0 and rup.rake < 150.0:
            # reverse
            TF = 1
        else:
            # normal
            NF = 1
        return SS, TF, NF

    #: Coefficients from SA from Table 1
    #: Coefficients from PGA e PGV from Table 5

    COEFFS = CoeffsTable(sa_damping=5, table="""
IMT 	a	        b1      	b2      	c1	        c2	        c3	        k	        f1	        f2	        tau	        phi_S2S	        phi_0	        Mh	Mref	        h
pgv	2.077429274	0.348633238	0.135912915	0.284090983	-1.456516476	-0.000572736	-0.592764071	0.041078235	-0.012312428	0.138852995	0.164147924	0.19385303	5.7	5.015545198	5.931021391
pga	3.421046409	0.19395409	-0.021982777	0.287149291	-1.405635476	-0.002911264	-0.39457597	0.085983743	0.010500239	0.155987833	0.220581579	0.200099141	5.5	5.323972714	6.923742944
0.01	3.424548332	0.192515984	-0.022650429	0.28752779	-1.406557404	-0.002909228	-0.393634495	0.085988213	0.010473297	0.156174175	0.220722569	0.200133122	5.5	5.326556877	6.926198355
0.025	3.483162098	0.174507233	-0.030319106	0.291771227	-1.424360823	-0.00284373	-0.380866129	0.086900796	0.012116892	0.158544677	0.223180571	0.200865727	5.5	5.372699588	6.927379297
0.04	3.650600661	0.115910253	-0.064666002	0.311111715	-1.46951193	-0.002731044	-0.342928442	0.08704777	0.016117753	0.164492009	0.232460239	0.203891711	5.5	5.496888968	6.981588795
0.05	3.731579718	0.093811147	-0.084727608	0.318474371	-1.4684793	-0.002910164	-0.320132687	0.090014146	0.012948638	0.167919709	0.238854027	0.206894356	5.5	5.555437358	7.121813763
0.07	3.829826542	0.077539942	-0.107450618	0.321983082	-1.469308994	-0.003492211	-0.277526674	0.102783546	0.022927122	0.17615611	0.251293793	0.210161077	5.5	5.505384723	7.290485836
0.1	3.804216981	0.136010968	-0.069220333	0.290860172	-1.401662752	-0.004300578	-0.268674388	0.114782454	0.024826935	0.178747872	0.263745845	0.211396158	5.5	5.379704457	7.274255576
0.15	3.650064155	0.256505072	0.027140096	0.233955124	-1.311175116	-0.004701823	-0.320756081	0.110947474	0.019865905	0.166676697	0.259614939	0.211311291	5.5	5.096576281	6.692774407
0.2	3.544107685	0.35614778	0.093492275	0.198357568	-1.280908575	-0.004512227	-0.376813964	0.094213006	0.011664018	0.161161328	0.249359375	0.208519927	5.5	4.801642244	6.127399588
0.25	3.490410856	0.425879462	0.143100786	0.176877955	-1.271020389	-0.003894721	-0.427580319	0.080322657	0.009763019	0.154143752	0.234958672	0.207445964	5.5	4.785109404	6.090794816
0.3	3.441537989	0.471774748	0.192603706	0.161491521	-1.294980137	-0.003219306	-0.477051544	0.077667564	0.006107754	0.146582519	0.224885923	0.205931698	5.5	4.716754196	5.97950255
0.35	3.344663067	0.506265812	0.215121147	0.156462115	-1.317817052	-0.002999059	-0.530656944	0.072839767	0.002699343	0.141087092	0.217584448	0.208002363	5.5	4.38121203	5.813099432
0.4	3.25505754	0.533124214	0.242162047	0.150282237	-1.280610322	-0.002742876	-0.556280843	0.066176059	0.001187068	0.135199994	0.214201933	0.20456609	5.5	4.459895815	5.807333052
0.45	3.364250407	0.536457858	0.185543896	0.148982374	-1.30182575	-0.002288974	-0.595031636	0.064849922	0.004904423	0.12827118	0.211640925	0.20383923	5.8	4.473399281	5.950514363
0.5	3.360850467	0.559515875	0.200209148	0.144588955	-1.357763194	-0.001821429	-0.61750213	0.064333658	0.004934471	0.129255315	0.210148637	0.202137846	5.8	4.306171827	6.082763315
0.6	3.313858622	0.615973457	0.242952695	0.130877618	-1.375111605	-0.00117831	-0.651527458	0.051750919	-0.010680738	0.138831934	0.208548334	0.201253267	5.8	4.262186443	6.096048657
0.7	3.221542456	0.641033191	0.263121772	0.131023146	-1.377758617	-0.000828809	-0.677025313	0.034834335	-0.013803439	0.148744576	0.207871215	0.199017716	5.8	4.224279197	5.870568678
0.75	3.194574866	0.661538479	0.275380527	0.127958215	-1.381658768	-0.000633262	-0.677000278	0.032560425	-0.010614431	0.149328112	0.20614746	0.19854442	5.8	4.219303208	5.939922607
0.8	3.147717201	0.674475458	0.284316832	0.127445497	-1.380523873	-0.000538791	-0.680760795	0.030150114	-0.009315058	0.148885808	0.205992333	0.197525181	5.8	4.178815956	5.915830881
0.9	3.043869232	0.696080838	0.290838987	0.130769664	-1.371229971	-0.000365081	-0.690160021	0.024386703	-0.005727461	0.151022088	0.208805953	0.196468196	5.8	4.128001924	5.649991511
1	2.932956282	0.716256926	0.299208561	0.133022152	-1.3581003	-0.000348128	-0.701038078	0.018783609	-0.002683827	0.149879988	0.209974067	0.195270635	5.8	4.006876496	5.426534761
1.2	2.796975463	0.752268361	0.314891447	0.135688239	-1.341891598	-0.000194616	-0.721144776	0.015669277	-0.012368258	0.147570864	0.20854696	0.193536957	5.8	4	5.211440099
1.4	2.668162729	0.778943975	0.331095885	0.137405321	-1.326542297	-0.000107129	-0.730412212	0.012284681	-0.015922067	0.148043062	0.208939176	0.19054011	5.8	4	5.091188342
1.6	2.572327016	0.784732808	0.339423909	0.14542251	-1.330858295	0	-0.738621601	0.003449908	-0.023124719	0.146822408	0.211988701	0.188832337	5.8	4.064442125	5.120626602
1.8	2.493338633	0.790002008	0.330543386	0.154228344	-1.328991252	0	-0.753819168	-0.007958762	-0.035448787	0.151755539	0.212597542	0.186158319	5.8	4.126409054	5.273707839
2	2.406017679	0.777734812	0.319950908	0.168479315	-1.328265515	0	-0.747200144	-0.011136997	-0.037530039	0.153344626	0.211226209	0.185543006	5.8	4.217477014	5.391098752
2.5	2.22513965	0.778991425	0.328072755	0.182779289	-1.359397794	0	-0.733274495	-0.029875517	-0.044707342	0.158145989	0.20574054	0.187313196	5.8	4.084119284	5.288543134
3	2.065364511	0.785537791	0.358587476	0.191737282	-1.362229161	-7.25E-05	-0.690729505	-0.05231421	-0.053472176	0.173056227	0.204694018	0.185637642	5.8	4	5.008980759
3.5	1.941369276	0.800682291	0.392471505	0.200310548	-1.345980871	-0.000329506	-0.65727018	-0.083113569	-0.049767112	0.169480856	0.200000288	0.185864773	5.8	4	5.223924913
4	1.808889377	0.774229371	0.386328884	0.220974666	-1.360549744	-0.000451476	-0.636132592	-0.085082875	-0.048192264	0.172919089	0.193342747	0.18769847	5.8	4	5.142828717
4.5	1.706704774	0.760657782	0.393227322	0.231865531	-1.360706439	-0.000542467	-0.621228954	-0.085178791	-0.042086194	0.175083614	0.191252851	0.187525832	5.8	4	4.994490856
5	1.567450851	0.735154096	0.407589944	0.244474177	-1.344397343	-0.000614288	-0.599612859	-0.074037219	-0.029493512	0.172465558	0.184993907	0.192077529	5.8	4.09951665	4.918263517
6	1.801566405	0.686606814	0.24003309	0.268139959	-1.427304718	-0.000407966	-0.558264382	-0.053015558	-0.028187971	0.160825832	0.182734365	0.186873864	6.3	4.072599778	5.619637389
7	1.659666801	0.668810803	0.291003986	0.273680446	-1.457575203	-0.000209233	-0.529391301	-0.016487933	-0.006375723	0.163992095	0.179306135	0.178578187	6.3	4.059787207	5.339307495
8	1.514641708	0.605314658	0.292723102	0.302100953	-1.452822069	-0.00018827	-0.50546158	0.001238847	-0.001138259	0.160530794	0.173753012	0.176947517	6.3	4.288415923	5.498454526
9	1.418685913	0.541385017	0.275162776	0.328335162	-1.435130879	0	-0.501517292	0.008360561	0.003631441	0.159364582	0.166677561	0.177127258	6.3	4.588494962	6
10	1.314212036	0.48973081	0.253629769	0.348443694	-1.442171374	0	-0.486730345	0.017001934	0.004416424	0.158088475	0.161666645	0.177639942	6.3	4.682670414	6.239119941

    """)


class LanzanoEtAl2019Rrup(LanzanoEtAl2019Rjb):
    """
    Implements LanzanoEtAl2019Rrup with rupture distance
    """

    REQUIRES_DISTANCES = set(('rrup', ))

    def _get_mean(self, C, rup, dists, sites):
        """
        Returns the mean ground motion
        """

        return (C['a']+self._compute_magnitude(rup.mag, C) +
            self._compute_distance(rup.mag, dists.rrup, C) +
            self._get_site_amplification_term(sites.vs30, C) +
            self._get_mechanism(rup, C))


    COEFFS = CoeffsTable(sa_damping=5, table="""
        IMT        a             b1           b2            c1             c2            c3              k            f1              f2           tau          phi_S2S        phi_0       Mh      Mref    h  
        pgv      2.382805181    0.238927926    0.026109741    0.340625195    -1.517870095    0    -0.57668062    0.049657419    0.004886722    0.137733865    0.165757794    0.194719087    5.7    5.498623765    5.260320221
        pga      3.847600913    0.077442274    -0.141999142    0.34786527    -1.553318752    -0.001876287    -0.380475638    0.098186392    0.031283998    0.161484907    0.221469359    0.200985777    5.5    5.716122587    6.641217458
        0.010    3.850624816    0.07586875    -0.142832271    0.348327944    -1.553739974    -0.001875834    -0.379518278    0.098202616    0.031288874    0.161701758    0.221604223    0.201019668    5.5    5.71829534    6.633953622
        0.025    3.919210388    0.055769698    -0.152764659    0.353720543    -1.575536277    -0.001783926    -0.366523237    0.099414836    0.03352307    0.164873939    0.223978163    0.201734852    5.5    5.758342909    6.641802864   
        0.040    4.117489277    -0.009033861    -0.193550285    0.376284724    -1.656180869    -0.001588876    -0.328028302    0.100397792    0.039148961    0.172842335    0.233003029    0.204702298    5.5    5.798963746    6.756388915
        0.050    4.210074905    -0.033949218    -0.216253444    0.385070769    -1.658827925    -0.001735064    -0.305138966    0.103840308    0.036431064    0.176956922    0.239349236    0.207279028    5.5    5.851350347    6.951124445
        0.070    4.311680208    -0.050561489    -0.239093011    0.388613187    -1.636007293    -0.002320163    -0.26257749    0.116955408    0.04680451    0.185049583    0.251547869    0.210697619    5.5    5.871871657    7.225446856
        0.100    4.261909141    0.015513515    -0.193111181    0.353610895    -1.560724007    -0.003193249    -0.254192212    0.128773048    0.048194668    0.187075597    0.264131977    0.211638401    5.5    5.781687554    7.19420496
        0.150    4.028133372    0.149053075    -0.084291046    0.290459636    -1.455885322    -0.003811128    -0.306586539    0.123429456    0.040992034    0.174794455    0.259792362    0.211901031    5.5    5.507041307    6.044836227
        0.200    3.95815618    0.258108514    -0.006761621    0.24931814    -1.430403095    -0.003504925    -0.363156746    0.105433695    0.03086753    0.166309565    0.25005757    0.209488132    5.5    5.408347068    6.081485968
        0.250    3.897516492    0.334995698    0.050482564    0.223937115    -1.416512943    -0.002897873    -0.414336074    0.090681705    0.027903312    0.15778909    0.235723115    0.208472393    5.5    5.451419    6.014388883
        0.300    3.838963104    0.384068815    0.103058999    0.20697198    -1.444078097    -0.002254134    -0.46369659    0.087412915    0.023431486    0.149604965    0.225933326    0.207368749    5.5    5.396885135    5.813524535
        0.350    3.742772439    0.422932063    0.130461277    0.199382025    -1.440825106    -0.002033897    -0.517498631    0.082083943    0.019139527    0.143710408    0.218507489    0.209870129    5.5    5.280655237    5.817749212
        0.400    3.633301375    0.452577637    0.160362191    0.191709196    -1.419023699    -0.001830147    -0.54342957    0.074815997    0.016968124    0.135875852    0.21494949    0.206488323    5.5    5.222200926    5.650118618
        0.450    3.715478118    0.455639613    0.109702761    0.189395051    -1.437348756    -0.001379017    -0.58220908    0.072461496    0.020082816    0.128720356    0.212445161    0.205745527    5.8    5.247882396    5.781105453
        0.500    3.722564493    0.479100015    0.125027052    0.184759334    -1.479288818    -0.000874635    -0.604867823    0.071913138    0.020177104    0.128651897    0.211321685    0.203665989    5.8    5.251777951    5.941687995
        0.60    3.668267068    0.536633552    0.168721328    0.17070595    -1.504966616    -0.000241138    -0.639218729    0.058886533    0.004648685    0.136565716    0.21002937    0.202472871    5.8    5.221943935    5.757565343
        0.700    3.547609804    0.560592527    0.187132163    0.171738894    -1.492015438    0    -0.664325056    0.041434528    0.00156405    0.144444474    0.209486512    0.200272384    5.8    5.169316554    5.223208645
        0.750    3.486015328    0.583551622    0.200975346    0.167616274    -1.470585831    0    -0.663366296    0.039074758    0.004591353    0.144419294    0.207549949    0.199924785    5.8    5.160801177    5.239071449
        0.800    3.41531767    0.596314019    0.209030535    0.167421493    -1.456390828    0    -0.666802546    0.0364159    0.005764477    0.143565039    0.207286338    0.199034326    5.8    5.108401346    5.019250866
        0.900    3.283775507    0.620364706    0.217432251    0.169562829    -1.426858993    0    -0.675076081    0.030297266    0.009217105    0.143959793    0.21004537    0.198096798    5.8    5.027301857    4.68887798
        1.000    3.164629845    0.639426875    0.224446688    0.172525702    -1.410437856    0    -0.685860401    0.024386222    0.012011019    0.142596349    0.211709541    0.196453998    5.8    4.915291837    4.278648454
        1.200    3.00006991    0.675260401    0.239800025    0.175434077    -1.384740205    0    -0.704986927    0.02038867    0.002085861    0.137674705    0.21063677    0.194705044    5.8    4.821941819    3.890257324
        1.400    2.854823911    0.701659838    0.255532261    0.177423461    -1.369305294    0    -0.713942078    0.016907157    -0.001627182    0.135287052    0.211077136    0.191451513    5.8    4.743852844    3.628258054
        1.600    2.74528842    0.70879026    0.264295535    0.184897873    -1.361692069    0    -0.721507452    0.008312197    -0.008300631    0.13319213    0.21419477    0.189535995    5.8    4.754923028    3.702529123
        1.800    2.664212962    0.715415298    0.256092111    0.193154623    -1.350783954    0    -0.737101157    -0.001732144    -0.019061818    0.138214794    0.214712386    0.186891771    5.8    4.813057451    3.958948022
        2.000    2.575686273    0.702843551    0.244714481    0.20761186    -1.347106574    0    -0.730750191    -0.005004016    -0.021235851    0.139787526    0.212929918    0.186477167    5.8    4.850661738    4.147937391
        2.500    2.39639594    0.70330507    0.251881853    0.222278047    -1.374318507    0    -0.716891787    -0.024634348    -0.029093691    0.143734389    0.206822207    0.188720647    5.8    4.720353777    4.11813896
        3.000  2.244276042    0.706440831    0.280579007    0.232394487    -1.393882554    0.00E+00    -0.675576711    -0.04493466    -0.0392006    0.157991644    0.205128554    0.18724625    5.8    4.596714128    3.667635891
        3.500    2.150945762    0.719714089    0.314495049    0.240887921    -1.305687507    0    -0.6454403    -0.071268681    -0.037741338    0.157441545    0.200506273    0.187622707    5.8    5    3.974670055
        4.000    2.026912941    0.687309221    0.303740183    0.264308669    -1.361285789    0    -0.625081532    -0.073655533    -0.036373029    0.161038097    0.194009718    0.189593901    5.8    4.816743112    3.584258252
        4.500    1.935079929    0.668771631    0.306146788    0.277846831    -1.314475128    0    -0.611029407    -0.074059363    -0.029498906    0.162329557    0.192762317    0.189388148    5.8    5    3.264468716
        5.000    1.809019248    0.64103302    0.318380771    0.291502178    -1.320909632    0    -0.589799058    -0.063248802    -0.017275089    0.160013489    0.187262191    0.194105498    5.8    5    3.354806043
        6.000    1.94551903    0.590199504    0.156420105    0.314002201    -1.337577152    0    -0.547811874    -0.042459937    -0.012585485    0.150958173    0.183890182    0.190020331    6.3    5    3.900620284
        7.000    1.783222309    0.57332373    0.201946761    0.319901626    -1.337459112    0    -0.519786195    -0.004575705    0.011116273    0.155518984    0.179430289    0.181998884    6.3    5    3.723331877
        8.000    1.647298285    0.507399328    0.200640939    0.349426108    -1.44638134    0    -0.495626616    0.013622261    0.017230593    0.152939434    0.173694587    0.180325415    6.3    4.810393158    4.3526246
        9.000    1.510571001    0.445032491    0.183061043    0.375134635    -1.436732413    0    -0.491201416    0.020894597    0.021726749    0.152956949    0.166244099    0.180419172    6.3    4.929588809    4.550985892
        10.000    1.396680656    0.390086786    0.15896026    0.396839442    -1.423253177    0    -0.476571304    0.029616488    0.02224686    0.152507791    0.161467973    0.180818116    6.3    5.0403227    4.599811512
    """)

